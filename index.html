<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INSI Script Overlay</title>
  <style>
    :root{
      --bg-color:#f4f4f9;
      --panel-bg:#ffffff;
      --primary:#007bff;
      --text-color:#333;
      --border-color:#ddd;
      --highlight:#ff0;
      --mp-bg:#c2f0fc;
      --cl-color:#555;
    }
    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      margin:0;
      padding:15px;
    }
    .container{
      max-width:900px;
      margin:auto;
      background:var(--panel-bg);
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
      border:1px solid var(--border-color);
    }
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      border-bottom:2px solid var(--border-color);
      padding-bottom:10px;
      flex-wrap:wrap;
    }
    .tab-btn{
      padding:10px 20px;
      border:none;
      background:#eee;
      cursor:pointer;
      border-radius:8px;
      font-weight:600;
      transition:0.3s;
      user-select:none;
    }
    .tab-btn.active{ background:var(--primary); color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .search-container{
      margin-bottom:15px;
      display:flex;
      gap:10px;
    }
    input[type="text"], textarea{
      width:100%;
      padding:12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      font-size:16px;
      box-sizing:border-box;
    }
    textarea{
      height:340px;
      font-family:monospace;
      line-height:1.25;
      resize:vertical;
      white-space:pre-wrap;
    }

    /* Ровные межстрочные расстояния (строка = div) */
    .script-box{
      background:#fafafa;
      padding:18px;
      border:1px solid var(--border-color);
      border-radius:8px;
      min-height:300px;
      font-size:16px;
      line-height:1.25;
      overflow-wrap:anywhere;
    }
    .line{ margin:2px 0; }
    .line.gap{ margin:10px 0; }

    .mp-pill{
      background:var(--mp-bg);
      border-radius:3px;
      padding:1px 4px;
      display:inline;
      line-height:1.1;
    }

    /* Клиент — чуть сдвинут вправо */
    .cl-text{
      color:var(--cl-color);
      display:inline-block;
      margin-left:12px;
    }

    .highlight{
      background:var(--highlight);
      font-weight:700;
      border-radius:3px;
      padding:0 2px;
    }

    .controls{
      margin-top:15px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      padding:10px 18px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
      transition:0.2s;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-success{ background:#28a745; color:#fff; }
    .btn-secondary{ background:#6c757d; color:#fff; }

    .hotkeys-info{
      font-size:12px;
      color:#777;
      margin-top:10px;
    }
    .hint{
      font-size:13px;
      color:#666;
      margin:8px 0 0;
    }

    /* === Самоконтроль: очень компактно === */
    .score-wrap{
      background:#fafafa;
      border:1px solid var(--border-color);
      border-radius:10px;
      padding:10px;
    }
    .score-head{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .score-title{
      margin:0;
      font-size:16px;
      font-weight:800;
    }
    .score-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .score-meta input{
      height:30px;
      padding:4px 8px;
      border:1px solid var(--border-color);
      border-radius:8px;
      font-size:13px;
      width:170px;
      box-sizing:border-box;
    }
    .pill{
      background:#fff;
      border:1px solid var(--border-color);
      border-radius:999px;
      padding:4px 8px;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .score-summary{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin:6px 0 10px;
    }
    .score-table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border:1px solid var(--border-color);
      border-radius:10px;
      overflow:hidden;
    }
    .score-table th, .score-table td{
      border-bottom:1px solid var(--border-color);
      padding:5px 8px;
      font-size:13px;
      line-height:1.1;
      vertical-align:top;
    }
    .score-table th{
      background:#f2f3f7;
      font-weight:800;
      padding:6px 8px;
      text-align:left;
    }
    .score-table tr:last-child td{ border-bottom:none; }
    .score-table .stage{
      font-weight:800;
      background:#fbfbfd;
    }
    .score-table .code{
      width:64px;
      color:#666;
      font-weight:700;
      white-space:nowrap;
    }
    .score-select{
      width:58px;
      height:26px;
      padding:0 6px;
      border:1px solid var(--border-color);
      border-radius:6px;
      font-size:13px;
      background:#fff;
    }
    .score-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
    }
    .small{
      font-size:12px;
      color:#666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="incoming">Входящий (Ctrl+I)</button>
      <button class="tab-btn" data-tab="outgoing">Исходящий (Ctrl+O)</button>
      <button class="tab-btn" data-tab="score">Самоконтроль</button>
      <button class="tab-btn" data-tab="edit">Редактирование</button>
    </div>

    <div id="incoming" class="tab-content active">
      <div class="search-container">
        <input type="text" id="incoming-search" placeholder="Поиск по фразе..." autocomplete="off">
      </div>
      <div id="incoming-text" class="script-box"></div>
      <div class="controls">
        <button class="btn btn-secondary" data-copy="incoming-text">Копировать всё</button>
      </div>
      <div class="hint">Подсказка: пустая строка в тексте делает аккуратный отступ между блоками.</div>
    </div>

    <div id="outgoing" class="tab-content">
      <div class="search-container">
        <input type="text" id="outgoing-search" placeholder="Поиск по фразе..." autocomplete="off">
      </div>
      <div id="outgoing-text" class="script-box"></div>
      <div class="controls">
        <button class="btn btn-secondary" data-copy="outgoing-text">Копировать всё</button>
      </div>
    </div>

    <!-- Самоконтроль -->
    <div id="score" class="tab-content">
      <div class="score-wrap">
        <div class="score-head">
          <h3 class="score-title">Самоконтроль звонка</h3>
          <div class="score-meta">
            <input id="score-agent" type="text" placeholder="Менеджер (например, Гагик)">
            <input id="score-date" type="text" placeholder="Дата (например, 08.01.26)">
          </div>
        </div>

        <div class="score-summary">
          <span class="pill" id="score-total">Итого: 0</span>
          <span class="pill" id="score-max">Максимум: 0</span>
          <span class="pill" id="score-percent">Процент: 0%</span>
          <span class="pill" id="score-grade">Оценка: —</span>
        </div>

        <table class="score-table" aria-label="Самоконтроль звонка">
          <thead>
            <tr>
              <th style="width:14%;">Код</th>
              <th>Пункт</th>
              <th style="width:90px;">Оценка</th>
            </tr>
          </thead>
          <tbody id="score-body"></tbody>
        </table>

        <div class="score-actions">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-success" id="score-save">Сохранить</button>
            <button class="btn btn-secondary" id="score-reset">Сбросить</button>
            <button class="btn btn-primary" id="score-copy">Копировать отчёт</button>
          </div>
          <div class="small">0 — нет, 1 — частично, 2 — да. Автоподсчёт сверху.</div>
        </div>
      </div>
    </div>

    <div id="edit" class="tab-content">
      <h3>Настройка скриптов</h3>

      <p>Входящий скрипт:</p>
      <textarea id="incoming-edit"></textarea>
      <button class="btn btn-success" data-save="incoming">Сохранить входящий</button>

      <p>Исходящий скрипт:</p>
      <textarea id="outgoing-edit"></textarea>
      <button class="btn btn-success" data-save="outgoing">Сохранить исходящий</button>

      <div class="controls">
        <button class="btn btn-primary" id="download-btn">Скачать бэкап (TXT)</button>
        <button class="btn btn-secondary" id="reset-btn">Сбросить к заводским</button>
      </div>

      <div class="hotkeys-info">
        Горячие клавиши: [Ctrl+I] Входящий | [Ctrl+O] Исходящий | Поиск работает мгновенно
      </div>
      <div class="hint">
        Формат текста: начинай строку с “МП:” для подсветки; “К:” можно писать — он будет скрыт, текст останется.
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY_IN = "incomingScript";
  const KEY_OUT = "outgoingScript";

  /* === Самоконтроль storage === */
  const KEY_SCORE = "insiCallSelfControl_v1";

  const defaultIncoming =
`МП: Здравствуйте! Компания ИНСИ. Меня зовут Рыкунов Андрей, я руководитель проекта.
МП: Подскажите, пожалуйста, как могу к вам обращаться?
К: Сергей
МП: Приятно, Сергей, слушаю вас.
К: (Озвучивает запрос)
МП: Отлично, для того чтобы посчитать для вас стоимость ангара и подготовить КП, мне нужно задать несколько вопросов, хорошо?
К: Да, давайте.

МП: Сергей, подскажите, пожалуйста, в каком городе планируете строительство?
К: Екатеринбург
МП: Уточните, пожалуйста, длину и ширину здания.
К: 20×25
МП: Какая высота по стене нужна?
К: 6 метров
МП: Сергей, подскажите, какое будет назначение у здания?
К: Склад лакокрасочной продукции

МП: Уточните, кран-балка нужна будет?
К: Да
МП: Принято. Какая грузоподъёмность кран-балки?
К: 5 тонн
МП: Ходить будет на всю длину?
К: На всю длину
МП: Один кран или несколько?
К: Один

МП: Теперь про утепление: сэндвич берём на стены 100 и крыша 150, или нужна другая толщина?
К: Да, подойдёт, стены 100 и крыша 150

МП: По крыше планируете двускатную или односкатную?
К: Давайте двускатную

МП: Перейдём к проёмам. Ворота — сколько их будет и какого размера?
К: Двое ворот, размером 3×4

МП: Хорошо. Двери?
К: Две двери, рядом с воротами

МП: Хорошо. Окна — как планируете их расположение?
К: Не знаю, а как лучше?

МП: Можно сделать отдельные окна, однако обычно на складах делают ленточное остекление по всему периметру, чтобы было больше естественного света на складе и можно было сэкономить на электричестве.
К: Хорошо, пусть будет ленточное остекление

МП: Сергей, будут какие-нибудь дополнительные особенности, которые нам нужно учесть?
К: Да, смотрите: рядом с входом, по правой стороне нужно будет сделать несколько кабинетов

МП: Сколько кабинетов и какого размера?
К: 4 кабинета, пусть каждый будет 2×3 метра

МП: Отлично, учтём и это. По техническим параметрам всё, осталось уточнить по монтажу и доставке.

МП: Монтаж посчитать?
К: Да, только отдельным счётом

МП: Доставку до Екатеринбурга считаем?
К: Да, но тоже отдельно

МП: По этим моментам всё. Сергей, в какие сроки планируете реализовать проект?
К: В этом квартале

МП: И последний вопрос: у вас уже выделено финансирование для строительства объекта?
К: В целом да, решение о финансировании уже есть, осталось определиться с бюджетом

МП: Сергей, спасибо за ответы. Нам нужно 2–3 рабочих дня, чтобы сделать предварительный расчёт и оформить КП. Насколько вам срочно?
К: 2–3 дня норм

МП: Тогда предлагаю сразу запланировать видеозвонок, чтобы подробно обсудить КП. В какое время в четверг вам удобно созвониться по видео?
К: Давайте во второй половине дня

МП: Тогда в четверг в 15:00, время Екатеринбург, хорошо?
К: Да

МП: На встрече ещё будут ваши коллеги, которым стоит презентовать наше КП, или только вы?
К: Только я

МП: Принято!

К: Отправьте КП мне на почту

МП: Конечно, я отправлю КП на почту перед встречей, потому что встреча нужна для детального обсуждения КП и параметров, которые влияют на цену.
МП: Например, снеговой район определяет расчётную нагрузку снега на кровлю.
МП: Уровень ответственности влияет на требования к надёжности и долговечности конструкций.
МП: Ветровой район влияет на выбор толщины профилей, способ крепления и общую устойчивость конструкции.
МП: В какое время в четверг вам удобно будет созвониться по видео?

К: Давайте утром, часов в 11
МП: Отлично, зафиксировал. На встрече ещё будут ваши коллеги или только вы?
К: Только я
МП: Принято!

МП: По email: если я вам в Telegram или WhatsApp напишу, вы сможете отправить email, чтобы сейчас не диктовать?
К: Да, конечно

МП: Тогда продиктуйте, пожалуйста, номер телефона, к которому привязаны Telegram или WhatsApp
К: 8 999 989 88 88

МП: Спасибо, зафиксировал.

МП: Два слова о том, как мы работаем: сейчас делаем предварительный расчёт, потом заключаем договор и выставляем счёт.
МП: После оплаты через 7 дней выдадим анкерное поле — вы сможете заливать фундамент.
МП: Пока вы заливаете фундамент, мы готовим проект и производим комплект для сборки.
МП: После производства отгружаем каркас, собираем и отгружаем сэндвич.

МП: Сергей, есть ли у вас вопросы?
К: Пока нет

МП: Подскажите, с какими конкурентными предложениями будете нас сравнивать?
К: Пока только к вам обратился

К: Кроме ангара из ЛСТК рассматриваю варианты из чёрного металла или арочные
МП: Понял, эти варианты тоже можем обсудить на встрече

К: Вот от Евраза тоже жду предложение
МП: Ясно, тогда на встрече обсудим и этот момент

МП: Итак, Сергей, подведём итог: мы посчитаем ангар по вашим параметрам, отдельно посчитаем монтаж и доставку до Екатеринбурга, и в четверг в 15:00 обсудим КП на видеовстрече — всё верно?
К: Да

МП: Тогда до встречи и спасибо за обращение в нашу компанию.
К: Спасибо, до свидания
МП: Всего доброго!`;

  const defaultOutgoing =
`К: Алло / Слушаю / Да
МП: Здравствуйте.
К: Здравствуйте.

МП: Меня зовут Владимир, я менеджер проекта компании ИНСИ. Вы интересовались быстровозводимыми зданиями, верно?
К: Да, было дело.

МП: Подскажите, как могу к вам обращаться?
К: Олег Николаевич

МП: Олег Николаевич, вам удобно сейчас ответить на мои вопросы, чтобы я мог всё вам рассчитать?
К: Да, удобно

МП: Подскажите, какое здание вы планировали построить?
К: Ангар, площадью примерно 450–500 квадратов

МП: Отлично. Тогда уточню параметры для расчёта.

МП: В каком городе планируете строительство?
К: Екатеринбург

МП: Уточните, пожалуйста, длину и ширину.
К: 20×25

МП: Какая высота по стене нужна?
К: 6 метров

МП: Олег Николаевич, подскажите, какое будет назначение у здания?
К: Склад лакокрасочной продукции

МП: Уточните, кран-балка нужна будет?
К: Да

МП: Какая грузоподъёмность кран-балки?
К: 5 тонн

МП: Ходить будет на всю длину?
К: На всю длину

МП: Один кран или несколько?
К: Один

МП: Теперь про утепление: сэндвич берём на стены 100 и крыша 150, или нужна другая толщина?
К: Да, подойдёт, стены 100 и крыша 150

МП: По крыше планируете двускатную или односкатную?
К: Давайте двускатную

МП: Перейдём к проёмам. Ворота — сколько их будет и какого размера?
К: Двое ворот, размером 3×4

МП: Хорошо. Двери?
К: Две двери, рядом с воротами

МП: Хорошо. Окна — как планируете их расположение?
К: Не знаю, а как лучше?

МП: Можно сделать отдельные окна, однако обычно на складах делают ленточное остекление по всему периметру, чтобы было больше естественного света на складе и можно было сэкономить на электричестве.
К: Хорошо, пусть будет ленточное остекление

МП: Олег Николаевич, будут какие-нибудь дополнительные особенности, которые нам нужно учесть?
К: Да, рядом с входом, по правой стороне нужно будет сделать несколько кабинетов

МП: Сколько кабинетов и какого размера?
К: 4 кабинета, пусть каждый будет 2×3 метра

МП: Отлично, учтём. По техническим параметрам всё, осталось уточнить по монтажу и доставке.

МП: Монтаж посчитать?
К: Да, только отдельным счётом

МП: Доставку до Екатеринбурга считаем?
К: Да, но тоже отдельно

МП: Олег Николаевич, в какие сроки планируете реализовать проект?
К: В этом квартале

МП: И последний вопрос: у вас уже выделено финансирование для строительства объекта?
К: В целом да, решение о финансировании уже есть, осталось определиться с бюджетом

МП: Олег Николаевич, спасибо за ответы. Нам нужно 2–3 рабочих дня, чтобы сделать предварительный расчёт и оформить КП. Насколько вам срочно?
К: 2–3 дня норм

МП: Тогда предлагаю сразу запланировать видеозвонок, чтобы подробно обсудить КП. В какое время в четверг вам удобно созвониться по видео?
К: Давайте во второй половине дня

МП: Тогда в четверг в 15:00, время Екатеринбург, хорошо?
К: Да

МП: На встрече ещё будут ваши коллеги, которым стоит презентовать наше КП, или только вы?
К: Только я

МП: Принято!

К: Отправьте КП мне на почту

МП: Конечно, отправлю КП на почту перед встречей, потому что встреча нужна для обсуждения параметров, которые влияют на цену.
МП: Например, снеговой район влияет на расчётную нагрузку снега на кровлю, ветровой район влияет на крепления и устойчивость, уровень ответственности влияет на требования к надёжности.
МП: В какое время в четверг вам удобно будет созвониться по видео?

К: Давайте утром, часов в 11

МП: Отлично, зафиксировал. На встрече будут коллеги или только вы?
К: Только я

МП: Принято! Если я вам в Telegram или WhatsApp напишу, сможете отправить email, чтобы сейчас не диктовать?
К: Да, конечно

МП: Тогда продиктуйте, пожалуйста, номер телефона, к которому привязаны Telegram или WhatsApp
К: 8 999 989 88 88

МП: Спасибо, зафиксировал.

МП: Два слова о том, как мы работаем: сейчас делаем предварительный расчёт, потом заключаем договор и выставляем счёт. После оплаты через 7 дней выдадим анкерное поле — сможете заливать фундамент. Пока вы заливаете фундамент, мы готовим проект и производим комплект. После производства отгружаем каркас и сэндвич.

МП: Олег Николаевич, есть ли у вас вопросы?
К: Пока нет

МП: Подскажите, с какими конкурентными предложениями будете нас сравнивать?
К: Пока только к вам обратился

К: Кроме ангара из ЛСТК рассматриваю варианты из чёрного металла или арочные
МП: Понял, тогда на встрече обсудим и эти варианты — мы тоже такие решения делаем

К: Вот от Евраза тоже жду предложение
МП: Ясно, тогда на встрече обсудим и этот момент

МП: Хорошо, тогда подведём итог: мы посчитаем ангар по вашим параметрам, отдельно посчитаем монтаж и доставку до Екатеринбурга, и в четверг в 15:00 обсудим КП на видеовстрече — всё верно?
К: Да

МП: Тогда до встречи и спасибо за обращение в нашу компанию.
К: Спасибо, до свидания
МП: Всего доброго!`;

  function safeStorageGet(key) {
    try { return localStorage.getItem(key); } catch (_) { return null; }
  }
  function safeStorageSet(key, val) {
    try { localStorage.setItem(key, val); return true; } catch (_) { return false; }
  }

  function stripClientPrefix(line) {
    return String(line).replace(/^\s*К\s*([:\-—])\s*/i, "");
  }
  function isMpLine(line) {
    return /^\s*МП\s*([:\-—])\s*/i.test(line);
  }
  function stripMpPrefix(line) {
    return String(line).replace(/^\s*МП\s*([:\-—])\s*/i, "");
  }
  function escapeRegExp(s) {
    return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function renderScriptLines(container, rawText, query) {
    container.innerHTML = "";

    const q = String(query || "").trim();
    const re = q ? new RegExp(escapeRegExp(q), "gi") : null;

    const lines = String(rawText ?? "").replace(/\r\n/g, "\n").split("\n");

    for (const lineRaw of lines) {
      const line = String(lineRaw);

      if (line.trim() === "") {
        const gap = document.createElement("div");
        gap.className = "line gap";
        container.appendChild(gap);
        continue;
      }

      const row = document.createElement("div");
      row.className = "line";

      let text = line;
      let mode = "cl";

      if (isMpLine(line)) {
        mode = "mp";
        text = stripMpPrefix(line);
      } else {
        text = stripClientPrefix(line);
      }

      const span = document.createElement("span");
      span.className = mode === "mp" ? "mp-pill" : "cl-text";

      if (!re) {
        span.textContent = text;
      } else {
        const parts = [];
        let last = 0;
        let m;
        re.lastIndex = 0;

        while ((m = re.exec(text)) !== null) {
          const before = text.slice(last, m.index);
          if (before) parts.push({t: before, h: false});
          parts.push({t: m[0], h: true});
          last = m.index + m[0].length;
          if (m[0].length === 0) break;
        }
        const after = text.slice(last);
        if (after) parts.push({t: after, h: false});

        for (const p of parts) {
          if (!p.h) span.appendChild(document.createTextNode(p.t));
          else {
            const mark = document.createElement("span");
            mark.className = "highlight";
            mark.textContent = p.t;
            span.appendChild(mark);
          }
        }
      }

      row.appendChild(span);
      container.appendChild(row);
    }
  }

  function getRaw(type) {
    const key = type === "incoming" ? KEY_IN : KEY_OUT;
    const def = type === "incoming" ? defaultIncoming : defaultOutgoing;
    return safeStorageGet(key) || def;
  }
  function setRaw(type, val) {
    const key = type === "incoming" ? KEY_IN : KEY_OUT;
    return safeStorageSet(key, String(val ?? ""));
  }

  function render(type) {
    const raw = getRaw(type);
    const query = document.getElementById(type + "-search")?.value?.trim() || "";
    const box = document.getElementById(type + "-text");
    renderScriptLines(box, raw, query);
  }

  function loadIntoEditor() {
    document.getElementById("incoming-edit").value = getRaw("incoming");
    document.getElementById("outgoing-edit").value = getRaw("outgoing");
  }

  /* === Самоконтроль: структура таблицы (как в примере) === */
  const scoreRows = [
    { type:"stage", code:"1", text:"Знакомство" },
    { type:"item",  code:"1.1", text:"Поздоровался" },
    { type:"item",  code:"1.2", text:"Представил себя" },
    { type:"item",  code:"1.3", text:"Представил компанию" },
    { type:"item",  code:"1.4", text:"Назвал свою должность" },
    { type:"item",  code:"1.5", text:"Назвал клиента по имени" },

    { type:"stage", code:"2", text:"Установление контакта" },
    { type:"item",  code:"2.1", text:"Уточнил удобство для разговора" },
    { type:"item",  code:"2.2", text:"Объяснил причину звонка" },
    { type:"item",  code:"2.3", text:"Вопрос для начала разговора" },

    { type:"stage", code:"3", text:"Выявление потребности" },
    { type:"item",  code:"3.0", text:"Разрешение задавать вопросы" },
    { type:"item",  code:"3.1", text:"Город строительства" },
    { type:"item",  code:"3.2", text:"Габариты: ширина, длина, высота" },
    { type:"item",  code:"3.3", text:"Проемы: ворота, окна, двери" },
    { type:"item",  code:"3.4", text:"Утепление (толщина сендвича)" },
    { type:"item",  code:"3.5", text:"Назначение здания" },
    { type:"item",  code:"3.6", text:"Наличие/Отсутствие кран балки" },
    { type:"item",  code:"3.7", text:"Тип крыши (односкатная, двускатная)" },
    { type:"item",  code:"3.8", text:"Дополнительные особенности" },
    { type:"item",  code:"3.9", text:"Монтаж" },
    { type:"item",  code:"3.10", text:"Доставка" },

    { type:"stage", code:"4", text:"Выявление ЛПР, ЛВР" },
    { type:"item",  code:"4.1", text:"Уточнение ЛПР, ЛВР" },

    { type:"stage", code:"5", text:"Бюджет, срочность, срок принятия решения, конкуренты" },
    { type:"item",  code:"5.1", text:"Уточнение по бюджету" },
    { type:"item",  code:"5.2", text:"Уточнение сроков принятия решения" },
    { type:"item",  code:"5.3", text:"Уточнение срочности выполнения работ" },
    { type:"item",  code:"5.4", text:"Уточнение по конкурентам" },

    { type:"stage", code:"6", text:"Путь клиента" },
    { type:"item",  code:"6.1", text:"Договоренность об обсуждении КП" },
    { type:"item",  code:"6.2", text:"Обозначение ближайших действий" },
    { type:"item",  code:"6.3", text:"Обозначение всех этапов взаимодействия" },

    { type:"stage", code:"7", text:"Завершение разговора" },
    { type:"item",  code:"7.1", text:"Подведение итогов разговора" },
    { type:"item",  code:"7.2", text:"Подтверждение следующего контакта" },
    { type:"item",  code:"7.3", text:"Прощание" },

    { type:"stage", code:"8", text:"Стиль разговора" },
    { type:"item",  code:"8.1", text:"Деловой" }
  ];

  function scoreBuildIfNeeded() {
    const tbody = document.getElementById("score-body");
    if (tbody.dataset.built === "1") return;

    tbody.innerHTML = "";
    for (const r of scoreRows) {
      const tr = document.createElement("tr");

      const tdCode = document.createElement("td");
      tdCode.className = "code";
      tdCode.textContent = r.code;

      const tdText = document.createElement("td");
      tdText.textContent = r.text;

      const tdVal = document.createElement("td");

      if (r.type === "stage") {
        tr.className = "stage";
        tdVal.textContent = "";
      } else {
        const sel = document.createElement("select");
        sel.className = "score-select";
        ["0","1","2"].forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        sel.value = "0";
        sel.addEventListener("change", scoreRecalc);
        tdVal.appendChild(sel);
      }

      tr.appendChild(tdCode);
      tr.appendChild(tdText);
      tr.appendChild(tdVal);
      tbody.appendChild(tr);
    }

    tbody.dataset.built = "1";
  }

  function scoreGetStateFromUI() {
    const agent = document.getElementById("score-agent").value || "";
    const date = document.getElementById("score-date").value || "";

    const tbody = document.getElementById("score-body");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    const items = [];
    let itemIndex = 0;
    for (let i = 0; i < scoreRows.length; i++) {
      const def = scoreRows[i];
      if (def.type === "stage") continue;
      const tr = rows[i];
      const sel = tr.querySelector("select");
      items.push({ idx: itemIndex, code: def.code, score: Number(sel?.value || 0) });
      itemIndex++;
    }
    return { agent, date, items, savedAt: new Date().toISOString() };
  }

  function scoreApplyStateToUI(state) {
    if (!state) return;

    document.getElementById("score-agent").value = state.agent || "";
    document.getElementById("score-date").value = state.date || "";

    const tbody = document.getElementById("score-body");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    const map = new Map();
    if (Array.isArray(state.items)) {
      for (const it of state.items) map.set(it.code, it.score);
    }

    for (let i = 0; i < scoreRows.length; i++) {
      const def = scoreRows[i];
      if (def.type === "stage") continue;
      const tr = rows[i];
      const sel = tr.querySelector("select");
      const v = map.has(def.code) ? map.get(def.code) : 0;
      if (sel) sel.value = String(v);
    }
  }

  function scoreLoad() {
    try {
      const raw = safeStorageGet(KEY_SCORE);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (_) { return null; }
  }

  function scoreSave(state) {
    try { return safeStorageSet(KEY_SCORE, JSON.stringify(state)); }
    catch (_) { return false; }
  }

  function scoreRecalc() {
    const tbody = document.getElementById("score-body");
    const sels = Array.from(tbody.querySelectorAll("select"));
    const total = sels.reduce((s, el) => s + Number(el.value || 0), 0);
    const max = sels.length * 2;
    const percent = max ? Math.round((total / max) * 100) : 0;

    document.getElementById("score-total").textContent = `Итого: ${total}`;
    document.getElementById("score-max").textContent = `Максимум: ${max}`;
    document.getElementById("score-percent").textContent = `Процент: ${percent}%`;

    // Градация как в примере (пороговые значения можно менять)
    let grade = "—";
    if (total >= 62) grade = "100%";
    else if (total >= 50) grade = "80%";
    else if (total >= 31) grade = "50%";
    else grade = "<50%";
    document.getElementById("score-grade").textContent = `Оценка: ${grade}`;
  }

  async function scoreCopyReport() {
    const st = scoreGetStateFromUI();
    const tbody = document.getElementById("score-body");
    const sels = Array.from(tbody.querySelectorAll("select"));
    const total = sels.reduce((s, el) => s + Number(el.value || 0), 0);

    const max = sels.length * 2;
    const percent = max ? Math.round((total / max) * 100) : 0;

    const lines = [];
    lines.push("Этапы звонка | Звонки");
    if (st.agent || st.date) lines.push(`${(st.agent || "").trim()} ${(st.date || "").trim()}`.trim());
    lines.push("");

    // Печатаем как в таблице: этапы и пункты с оценкой
    let rowIndex = 0;
    for (const def of scoreRows) {
      if (def.type === "stage") {
        lines.push(`${def.code}. ${def.text}`);
      } else {
        const tr = tbody.querySelectorAll("tr")[rowIndex];
        const val = tr.querySelector("select")?.value ?? "0";
        lines.push(`${def.code} ${def.text}`);
        lines.push(String(val));
      }
      rowIndex++;
    }

    lines.push("");
    lines.push(`Итог: ${total} (из ${max}, ${percent}%)`);

    // copy
    try {
      if (window.isSecureContext && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(lines.join("\n"));
      } else {
        const ta = document.createElement("textarea");
        ta.value = lines.join("\n");
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      alert("Скопировано!");
    } catch (e) {
      alert("Не удалось скопировать (проверь HTTPS/права браузера).");
    }
  }

  function scoreReset() {
    const tbody = document.getElementById("score-body");
    Array.from(tbody.querySelectorAll("select")).forEach(s => s.value = "0");
    document.getElementById("score-agent").value = "";
    document.getElementById("score-date").value = "";
    scoreRecalc();
    try { localStorage.removeItem(KEY_SCORE); } catch (_) {}
  }

  function renderScore() {
    scoreBuildIfNeeded();
    const saved = scoreLoad();
    if (saved) scoreApplyStateToUI(saved);
    scoreRecalc();
  }

  function switchTab(name) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

    document.getElementById(name).classList.add("active");
    document.querySelector(`.tab-btn[data-tab="${name}"]`)?.classList.add("active");

    if (name === "incoming") render("incoming");
    if (name === "outgoing") render("outgoing");
    if (name === "edit") loadIntoEditor();
    if (name === "score") renderScore();
  }

  async function copyBoxText(boxId) {
    const el = document.getElementById(boxId);
    const text = el ? el.innerText : "";

    try {
      if (window.isSecureContext && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      alert("Скопировано!");
    } catch (e) {
      alert("Не удалось скопировать (проверь HTTPS/права браузера).");
    }
  }

  function downloadAll() {
    const i = getRaw("incoming");
    const o = getRaw("outgoing");
    const blob = new Blob([`INCOMING:\n${i}\n\nOUTGOING:\n${o}\n`], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "scripts-backup.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function resetToDefault() {
    if (!confirm("Сбросить к заводским?")) return;
    try { localStorage.removeItem(KEY_IN); localStorage.removeItem(KEY_OUT); } catch (_) {}
    render("incoming");
    render("outgoing");
    loadIntoEditor();
  }

  document.addEventListener("DOMContentLoaded", () => {
    render("incoming");
    render("outgoing");

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });

    document.getElementById("incoming-search").addEventListener("input", () => render("incoming"));
    document.getElementById("outgoing-search").addEventListener("input", () => render("outgoing"));

    document.querySelectorAll("[data-save]").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.save;
        const val = document.getElementById(type + "-edit").value;
        if (setRaw(type, val)) {
          render(type);
          alert("Сохранено!");
        } else {
          alert("Не удалось сохранить (localStorage недоступен).");
        }
      });
    });

    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", () => copyBoxText(btn.dataset.copy));
    });

    document.getElementById("download-btn").addEventListener("click", downloadAll);
    document.getElementById("reset-btn").addEventListener("click", resetToDefault);

    // Самоконтроль кнопки
    document.getElementById("score-save").addEventListener("click", () => {
      const st = scoreGetStateFromUI();
      if (scoreSave(st)) alert("Самоконтроль сохранён!");
      else alert("Не удалось сохранить самоконтроль.");
    });
    document.getElementById("score-reset").addEventListener("click", () => {
      if (!confirm("Сбросить самоконтроль?")) return;
      scoreReset();
    });
    document.getElementById("score-copy").addEventListener("click", scoreCopyReport);

    // Автопересчёт при вводе имени/даты (не влияет на баллы, просто чтобы сохранялось)
    document.getElementById("score-agent").addEventListener("input", () => {});
    document.getElementById("score-date").addEventListener("input", () => {});

    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.code === "KeyI") { e.preventDefault(); switchTab("incoming"); }
      if (e.ctrlKey && e.code === "KeyO") { e.preventDefault(); switchTab("outgoing"); }
    });
  });
})();
</script>
</body>
</html>
