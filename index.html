<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INSI Script Overlay</title>
  <style>
    :root{
      --bg-color:#f4f4f9;
      --panel-bg:#ffffff;
      --primary:#007bff;
      --text-color:#333;
      --border-color:#ddd;
      --highlight:#ff0;
      --mp-bg:#c2f0fc;
      --cl-color:#555;
      --muted:#666;
    }
    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      margin:0;
      padding:15px;
    }
    .container{
      max-width:980px;
      margin:auto;
      background:var(--panel-bg);
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
      border:1px solid var(--border-color);
    }
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      border-bottom:2px solid var(--border-color);
      padding-bottom:10px;
      flex-wrap:wrap;
    }
    .tab-btn{
      padding:10px 20px;
      border:none;
      background:#eee;
      cursor:pointer;
      border-radius:8px;
      font-weight:600;
      transition:0.3s;
      user-select:none;
    }
    .tab-btn.active{ background:var(--primary); color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .search-container{
      margin-bottom:15px;
      display:flex;
      gap:10px;
    }
    input[type="text"], textarea{
      width:100%;
      padding:12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      font-size:16px;
      box-sizing:border-box;
    }
    textarea{
      height:340px;
      font-family:monospace;
      line-height:1.25;
      resize:vertical;
      white-space:pre-wrap;
    }

    /* Ровные межстрочные расстояния (строка = div) */
    .script-box{
      background:#fafafa;
      padding:18px;
      border:1px solid var(--border-color);
      border-radius:8px;
      min-height:300px;
      font-size:16px;
      line-height:1.25;
      overflow-wrap:anywhere;
    }
    .line{ margin:2px 0; }
    .line.gap{ margin:10px 0; }

    .mp-pill{
      background:var(--mp-bg);
      border-radius:3px;
      padding:1px 4px;
      display:inline;
      line-height:1.1;
    }

    /* Клиент — чуть сдвинут вправо */
    .cl-text{
      color:var(--cl-color);
      display:inline-block;
      margin-left:12px;
    }

    .highlight{
      background:var(--highlight);
      font-weight:700;
      border-radius:3px;
      padding:0 2px;
    }

    .controls{
      margin-top:15px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      padding:10px 18px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
      transition:0.2s;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-success{ background:#28a745; color:#fff; }
    .btn-secondary{ background:#6c757d; color:#fff; }

    .hotkeys-info{
      font-size:12px;
      color:#777;
      margin-top:10px;
    }
    .hint{
      font-size:13px;
      color:var(--muted);
      margin:8px 0 0;
    }

    /* === Самоконтроль: компактно === */
    .score-wrap{
      background:#fafafa;
      border:1px solid var(--border-color);
      border-radius:10px;
      padding:10px;
    }
    .score-head{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .score-title{
      font-size:16px;
      font-weight:700;
      margin:0;
    }
    .score-summary{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      background:#fff;
      border:1px solid var(--border-color);
      border-radius:999px;
      padding:4px 8px;
      color:#333;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }
    .score-table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border:1px solid var(--border-color);
      border-radius:10px;
      overflow:hidden;
    }
    .score-table th, .score-table td{
      border-bottom:1px solid var(--border-color);
      padding:6px 8px;
      vertical-align:top;
      font-size:13px;
      line-height:1.15;
    }
    .score-table th{
      text-align:left;
      background:#f2f3f7;
      font-weight:700;
      padding:7px 8px;
    }
    .score-table tr:last-child td{ border-bottom:none; }
    .score-select{
      width:64px;
      padding:2px 6px;
      border:1px solid var(--border-color);
      border-radius:6px;
      font-size:13px;
      background:#fff;
      height:28px;
    }

    /* Комментарий — одна строка (input), очень компактно */
    .score-note{
      width:100%;
      height:28px;
      padding:2px 8px;
      border:1px solid var(--border-color);
      border-radius:6px;
      font-size:13px;
      line-height:1.15;
      box-sizing:border-box;
    }

    .score-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      justify-content:space-between;
    }
    .score-actions .left, .score-actions .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="incoming">Входящий (Ctrl+I)</button>
      <button class="tab-btn" data-tab="outgoing">Исходящий (Ctrl+O)</button>
      <button class="tab-btn" data-tab="score">Самоконтроль</button>
      <button class="tab-btn" data-tab="edit">Редактирование</button>
    </div>

    <div id="incoming" class="tab-content active">
      <div class="search-container">
        <input type="text" id="incoming-search" placeholder="Поиск по фразе..." autocomplete="off">
      </div>
      <div id="incoming-text" class="script-box"></div>
      <div class="controls">
        <button class="btn btn-secondary" data-copy="incoming-text">Копировать всё</button>
      </div>
      <div class="hint">Подсказка: пустая строка в тексте делает аккуратный отступ между блоками.</div>
    </div>

    <div id="outgoing" class="tab-content">
      <div class="search-container">
        <input type="text" id="outgoing-search" placeholder="Поиск по фразе..." autocomplete="off">
      </div>
      <div id="outgoing-text" class="script-box"></div>
      <div class="controls">
        <button class="btn btn-secondary" data-copy="outgoing-text">Копировать всё</button>
      </div>
    </div>

    <div id="score" class="tab-content">
      <div class="score-wrap">
        <div class="score-head">
          <h3 class="score-title">Самоконтроль звонка</h3>
          <div class="score-summary">
            <span class="pill" id="score-total">Итого: 0</span>
            <span class="pill" id="score-max">Максимум: 0</span>
            <span class="pill" id="score-percent">Процент: 0%</span>
          </div>
        </div>

        <table class="score-table" aria-label="Самоконтроль звонка">
          <thead>
            <tr>
              <th style="width:52%;">Критерий</th>
              <th style="width:12%;">Балл</th>
              <th>Комментарий</th>
            </tr>
          </thead>
          <tbody id="score-body"></tbody>
        </table>

        <div class="score-actions">
          <div class="left">
            <button class="btn btn-success" id="score-save">Сохранить</button>
            <button class="btn btn-secondary" id="score-reset">Сбросить</button>
          </div>
          <div class="right">
            <button class="btn btn-primary" id="score-copy">Копировать отчёт</button>
            <span class="small">Шкала: 0 — нет, 1 — частично, 2 — да.</span>
          </div>
        </div>
      </div>
    </div>

    <div id="edit" class="tab-content">
      <h3>Настройка скриптов</h3>

      <p>Входящий скрипт:</p>
      <textarea id="incoming-edit"></textarea>
      <button class="btn btn-success" data-save="incoming">Сохранить входящий</button>

      <p>Исходящий скрипт:</p>
      <textarea id="outgoing-edit"></textarea>
      <button class="btn btn-success" data-save="outgoing">Сохранить исходящий</button>

      <div class="controls">
        <button class="btn btn-primary" id="download-btn">Скачать бэкап (TXT)</button>
        <button class="btn btn-secondary" id="reset-btn">Сбросить к заводским</button>
      </div>

      <div class="hotkeys-info">
        Горячие клавиши: [Ctrl+I] Входящий | [Ctrl+O] Исходящий | Поиск работает мгновенно
      </div>
      <div class="hint">
        Формат текста: начинай строку с “МП:” для подсветки; “К:” можно писать — он будет скрыт, текст останется.
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY_IN = "incomingScript";
  const KEY_OUT = "outgoingScript";
  const KEY_SCORE = "callSelfScore_v1";

  const defaultIncoming =
`МП: Здравствуйте! Компания ИНСИ. Меня зовут Рыкунов Андрей, я руководитель проекта.
МП: Подскажите, пожалуйста, как могу к вам обращаться?
К: Сергей
МП: Приятно, Сергей, слушаю вас.
К: (Озвучивает запрос)
МП: Отлично, для того чтобы посчитать для вас стоимость ангара и подготовить КП, мне нужно задать несколько вопросов, хорошо?
К: Да, давайте.

МП: Сергей, подскажите, пожалуйста, в каком городе планируете строительство?
К: Екатеринбург
МП: Уточните, пожалуйста, длину и ширину здания.
К: 20×25
МП: Какая высота по стене нужна?
К: 6 метров
МП: Сергей, подскажите, какое будет назначение у здания?
К: Склад лакокрасочной продукции`;

  const defaultOutgoing =
`К: Алло / Слушаю / Да
МП: Здравствуйте.
К: Здравствуйте.

МП: Меня зовут Владимир, я менеджер проекта компании ИНСИ. Вы интересовались быстровозводимыми зданиями, верно?
К: Да, было дело.

МП: Подскажите, как могу к вам обращаться?
К: Олег Николаевич

МП: Олег Николаевич, вам удобно сейчас ответить на мои вопросы, чтобы я мог всё вам рассчитать?
К: Да, удобно`;

  function safeStorageGet(key) {
    try { return localStorage.getItem(key); } catch (_) { return null; }
  }
  function safeStorageSet(key, val) {
    try { localStorage.setItem(key, val); return true; } catch (_) { return false; }
  }

  function stripClientPrefix(line) {
    return String(line).replace(/^\s*К\s*([:\-—])\s*/i, "");
  }
  function isMpLine(line) {
    return /^\s*МП\s*([:\-—])\s*/i.test(line);
  }
  function stripMpPrefix(line) {
    return String(line).replace(/^\s*МП\s*([:\-—])\s*/i, "");
  }
  function escapeRegExp(s) {
    return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function renderScriptLines(container, rawText, query) {
    container.innerHTML = "";

    const q = String(query || "").trim();
    const re = q ? new RegExp(escapeRegExp(q), "gi") : null;

    const lines = String(rawText ?? "").replace(/\r\n/g, "\n").split("\n");

    for (const lineRaw of lines) {
      const line = String(lineRaw);

      if (line.trim() === "") {
        const gap = document.createElement("div");
        gap.className = "line gap";
        container.appendChild(gap);
        continue;
      }

      const row = document.createElement("div");
      row.className = "line";

      let text = line;
      let mode = "cl";

      if (isMpLine(line)) {
        mode = "mp";
        text = stripMpPrefix(line);
      } else {
        text = stripClientPrefix(line);
      }

      const span = document.createElement("span");
      span.className = mode === "mp" ? "mp-pill" : "cl-text";

      if (!re) {
        span.textContent = text;
      } else {
        const parts = [];
        let last = 0;
        let m;
        re.lastIndex = 0;

        while ((m = re.exec(text)) !== null) {
          const before = text.slice(last, m.index);
          if (before) parts.push({t: before, h: false});
          parts.push({t: m[0], h: true});
          last = m.index + m[0].length;
          if (m[0].length === 0) break;
        }
        const after = text.slice(last);
        if (after) parts.push({t: after, h: false});

        for (const p of parts) {
          if (!p.h) span.appendChild(document.createTextNode(p.t));
          else {
            const mark = document.createElement("span");
            mark.className = "highlight";
            mark.textContent = p.t;
            span.appendChild(mark);
          }
        }
      }

      row.appendChild(span);
      container.appendChild(row);
    }
  }

  function getRaw(type) {
    const key = type === "incoming" ? KEY_IN : KEY_OUT;
    const def = type === "incoming" ? defaultIncoming : defaultOutgoing;
    return safeStorageGet(key) || def;
  }
  function setRaw(type, val) {
    const key = type === "incoming" ? KEY_IN : KEY_OUT;
    return safeStorageSet(key, String(val ?? ""));
  }

  function render(type) {
    const raw = getRaw(type);
    const query = document.getElementById(type + "-search")?.value?.trim() || "";
    const box = document.getElementById(type + "-text");
    renderScriptLines(box, raw, query);
  }

  function loadIntoEditor() {
    document.getElementById("incoming-edit").value = getRaw("incoming");
    document.getElementById("outgoing-edit").value = getRaw("outgoing");
  }

  function switchTab(name) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

    document.getElementById(name).classList.add("active");
    document.querySelector(`.tab-btn[data-tab="${name}"]`)?.classList.add("active");

    if (name === "incoming") render("incoming");
    if (name === "outgoing") render("outgoing");
    if (name === "edit") loadIntoEditor();
    if (name === "score") renderScore();
  }

  async function copyBoxText(boxId) {
    const el = document.getElementById(boxId);
    const text = el ? el.innerText : "";

    try {
      if (window.isSecureContext && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      alert("Скопировано!");
    } catch (e) {
      alert("Не удалось скопировать (проверь HTTPS/права браузера).");
    }
  }

  async function copyPlainText(text) {
    try {
      if (window.isSecureContext && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      alert("Скопировано!");
    } catch (e) {
      alert("Не удалось скопировать (проверь HTTPS/права браузера).");
    }
  }

  function downloadAll() {
    const i = getRaw("incoming");
    const o = getRaw("outgoing");
    const blob = new Blob([`INCOMING:\n${i}\n\nOUTGOING:\n${o}\n`], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "scripts-backup.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function resetToDefault() {
    if (!confirm("Сбросить к заводским?")) return;
    try { localStorage.removeItem(KEY_IN); localStorage.removeItem(KEY_OUT); } catch (_) {}
    render("incoming");
    render("outgoing");
    loadIntoEditor();
  }

  // =========================
  // Самоконтроль (0/1/2 + сумма)
  // =========================
  const scoreItems = [
    "Приветствие и представление прозвучали чётко.",
    "Спросил, как обращаться, и использовал имя клиента.",
    "Выслушал запрос клиента и подтвердил понимание.",
    "Взял разрешение задавать вопросы для расчёта.",
    "Собрал город строительства.",
    "Собрал габариты (длина×ширина, высота).",
    "Уточнил назначение здания.",
    "Уточнил кран-балку (если нужно — доп. параметры).",
    "Уточнил утепление (стены/кровля).",
    "Уточнил тип крыши.",
    "Собрал проёмы (ворота/двери/окна).",
    "Уточнил дополнительные особенности/перегородки.",
    "Уточнил монтаж (включать/отдельно).",
    "Уточнил доставку (включать/отдельно).",
    "Уточнил сроки реализации.",
    "Уточнил финансирование/готовность бюджета.",
    "Зафиксировал срок подготовки КП (2–3 дня) и срочность.",
    "Назначил видеовстречу (дата/время) или чёткий следующий шаг.",
    "Уточнил участников встречи (ЛПР/коллеги).",
    "Уточнил конкурентов/с чем сравнивают.",
    "Подвёл итог договорённостей и завершил разговор."
  ];

  function scoreLoad() {
    try {
      const raw = safeStorageGet(KEY_SCORE);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (_) {
      return null;
    }
  }

  function scoreSave(state) {
    try {
      safeStorageSet(KEY_SCORE, JSON.stringify(state));
      return true;
    } catch (_) {
      return false;
    }
  }

  function scoreGetStateFromUI() {
    const tbody = document.getElementById("score-body");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const items = rows.map((tr, idx) => {
      const sel = tr.querySelector("select");
      const note = tr.querySelector(".score-note");
      return {
        i: idx,
        score: Number(sel.value),
        note: String(note.value || "")
      };
    });
    return { items, savedAt: new Date().toISOString() };
  }

  function scoreApplyStateToUI(state) {
    const tbody = document.getElementById("score-body");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const map = new Map();
    if (state && Array.isArray(state.items)) {
      for (const it of state.items) map.set(it.i, it);
    }
    rows.forEach((tr, idx) => {
      const sel = tr.querySelector("select");
      const note = tr.querySelector(".score-note");
      const it = map.get(idx);
      if (it) {
        sel.value = String(it.score ?? 0);
        note.value = String(it.note ?? "");
      } else {
        sel.value = "0";
        note.value = "";
      }
    });
  }

  function scoreRecalc() {
    const tbody = document.getElementById("score-body");
    const sels = Array.from(tbody.querySelectorAll("select"));
    const total = sels.reduce((sum, s) => sum + Number(s.value || 0), 0);
    const max = scoreItems.length * 2;
    const percent = max ? Math.round((total / max) * 100) : 0;

    document.getElementById("score-total").textContent = `Итого: ${total}`;
    document.getElementById("score-max").textContent = `Максимум: ${max}`;
    document.getElementById("score-percent").textContent = `Процент: ${percent}%`;
  }

  function scoreBuildTableIfNeeded() {
    const tbody = document.getElementById("score-body");
    if (tbody.dataset.built === "1") return;

    tbody.innerHTML = "";
    scoreItems.forEach((txt) => {
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.textContent = txt;

      const td2 = document.createElement("td");
      const sel = document.createElement("select");
      sel.className = "score-select";
      ["0","1","2"].forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
      sel.value = "0";
      sel.addEventListener("change", scoreRecalc);
      td2.appendChild(sel);

      const td3 = document.createElement("td");
      const note = document.createElement("input");
      note.type = "text";
      note.className = "score-note";
      note.placeholder = "Комментарий";
      td3.appendChild(note);

      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tbody.appendChild(tr);
    });

    tbody.dataset.built = "1";
  }

  function renderScore() {
    scoreBuildTableIfNeeded();
    const saved = scoreLoad();
    if (saved) scoreApplyStateToUI(saved);
    scoreRecalc();
  }

  async function scoreCopyReport() {
    const state = scoreGetStateFromUI();
    const total = state.items.reduce((s, it) => s + Number(it.score || 0), 0);
    const max = scoreItems.length * 2;
    const percent = max ? Math.round((total / max) * 100) : 0;

    const lines = [];
    lines.push(`Самоконтроль звонка`);
    lines.push(`Итого: ${total} / ${max} (${percent}%)`);
    lines.push(``);

    state.items.forEach((it, idx) => {
      const crit = scoreItems[idx];
      const sc = it.score;
      const note = (it.note || "").trim();
      lines.push(`${idx + 1}. [${sc}] ${crit}${note ? " — " + note : ""}`);
    });

    await copyPlainText(lines.join("\n"));
  }

  function scoreResetUI() {
    const tbody = document.getElementById("score-body");
    Array.from(tbody.querySelectorAll("select")).forEach(s => s.value = "0");
    Array.from(tbody.querySelectorAll(".score-note")).forEach(t => t.value = "");
    scoreRecalc();
  }

  // =========================
  // Wiring
  // =========================
  document.addEventListener("DOMContentLoaded", () => {
    render("incoming");
    render("outgoing");

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });

    document.getElementById("incoming-search").addEventListener("input", () => render("incoming"));
    document.getElementById("outgoing-search").addEventListener("input", () => render("outgoing"));

    document.querySelectorAll("[data-save]").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.save;
        const val = document.getElementById(type + "-edit").value;
        if (setRaw(type, val)) {
          render(type);
          alert("Сохранено!");
        } else {
          alert("Не удалось сохранить (localStorage недоступен).");
        }
      });
    });

    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", () => copyBoxText(btn.dataset.copy));
    });

    document.getElementById("download-btn").addEventListener("click", downloadAll);
    document.getElementById("reset-btn").addEventListener("click", resetToDefault);

    // Самоконтроль: кнопки
    document.getElementById("score-save").addEventListener("click", () => {
      const state = scoreGetStateFromUI();
      scoreSave(state);
      alert("Самоконтроль сохранён!");
    });

    document.getElementById("score-reset").addEventListener("click", () => {
      if (!confirm("Сбросить оценки (вкладка Самоконтроль)?")) return;
      scoreResetUI();
      try { localStorage.removeItem(KEY_SCORE); } catch (_) {}
    });

    document.getElementById("score-copy").addEventListener("click", scoreCopyReport);

    // hotkeys
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.code === "KeyI") { e.preventDefault(); switchTab("incoming"); }
      if (e.ctrlKey && e.code === "KeyO") { e.preventDefault(); switchTab("outgoing"); }
    });
  });
})();
</script>
</body>
</html>
