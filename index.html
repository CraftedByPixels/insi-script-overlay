<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INSI Script Overlay</title>
  <style>
    :root{
      --bg-color:#f4f4f9;
      --panel-bg:#ffffff;
      --primary:#007bff;
      --text-color:#333;
      --border-color:#ddd;
      --highlight:#ff0;
      --mp-bg:#c2f0fc;
      --cl-color:#555;
    }
    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      margin:0;
      padding:15px;
    }
    .container{
      max-width:900px;
      margin:auto;
      background:var(--panel-bg);
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
      border:1px solid var(--border-color);
    }
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      border-bottom:2px solid var(--border-color);
      padding-bottom:10px;
      flex-wrap:wrap;
    }
    .tab-btn{
      padding:10px 20px;
      border:none;
      background:#eee;
      cursor:pointer;
      border-radius:8px;
      font-weight:600;
      transition:0.3s;
      user-select:none;
    }
    .tab-btn.active{ background:var(--primary); color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .search-container{
      margin-bottom:15px;
      display:flex;
      gap:10px;
    }
    input[type="text"], textarea{
      width:100%;
      padding:12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      font-size:16px;
      box-sizing:border-box;
    }
    textarea{
      height:340px;
      font-family:monospace;
      line-height:1.25;
      resize:vertical;
      white-space:pre-wrap;
    }

    /* === Ровные межстрочные расстояния (строка = div) === */
    .script-box{
      background:#fafafa;
      padding:18px;
      border:1px solid var(--border-color);
      border-radius:8px;
      min-height:300px;
      font-size:16px;
      line-height:1.25;
      overflow-wrap:anywhere;
    }
    .line{
      margin:2px 0;            /* одинаково между всеми строками */
    }
    .line.gap{
      margin:10px 0;           /* “пустая строка” = разделитель блока */
    }

    .mp-pill{
      background:var(--mp-bg);
      border-radius:3px;
      padding:1px 4px;
      display:inline;
      line-height:1.1;
    }
    .cl-text{
      color:var(--cl-color);
    }

    .highlight{
      background:var(--highlight);
      font-weight:700;
      border-radius:3px;
      padding:0 2px;
    }

    .controls{
      margin-top:15px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      padding:10px 18px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
      transition:0.2s;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-success{ background:#28a745; color:#fff; }
    .btn-secondary{ background:#6c757d; color:#fff; }

    .hotkeys-info{
      font-size:12px;
      color:#777;
      margin-top:10px;
    }
    .hint{
      font-size:13px;
      color:#666;
      margin:8px 0 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="incoming">Входящий (Ctrl+I)</button>
      <button class="tab-btn" data-tab="outgoing">Исходящий (Ctrl+O)</button>
      <button class="tab-btn" data-tab="edit">Редактирование</button>
    </div>

    <div id="incoming" class="tab-content active">
      <div class="search-container">
        <input type="text" id="incoming-search" placeholder="Поиск по фразе..." autocomplete="off">
      </div>
      <div id="incoming-text" class="script-box"></div>
      <div class="controls">
        <button class="btn btn-secondary" data-copy="incoming-text">Копировать всё</button>
      </div>
      <div class="hint">Подсказка: пустая строка в тексте делает аккуратный отступ между блоками.</div>
    </div>

    <div id="outgoing" class="tab-content">
      <div class="search-container">
        <input type="text" id="outgoing-search" placeholder="Поиск по фразе..." autocomplete="off">
      </div>
      <div id="outgoing-text" class="script-box"></div>
      <div class="controls">
        <button class="btn btn-secondary" data-copy="outgoing-text">Копировать всё</button>
      </div>
    </div>

    <div id="edit" class="tab-content">
      <h3>Настройка скриптов</h3>

      <p>Входящий скрипт:</p>
      <textarea id="incoming-edit"></textarea>
      <button class="btn btn-success" data-save="incoming">Сохранить входящий</button>

      <p>Исходящий скрипт:</p>
      <textarea id="outgoing-edit"></textarea>
      <button class="btn btn-success" data-save="outgoing">Сохранить исходящий</button>

      <div class="controls">
        <button class="btn btn-primary" id="download-btn">Скачать бэкап (TXT)</button>
        <button class="btn btn-secondary" id="reset-btn">Сбросить к заводским</button>
      </div>

      <div class="hotkeys-info">
        Горячие клавиши: [Ctrl+I] Входящий | [Ctrl+O] Исходящий | Поиск работает мгновенно
      </div>
      <div class="hint">
        Формат текста: начинай строку с “МП:” для подсветки; “К:” можно писать — он будет скрыт, текст останется.
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY_IN = "incomingScript";
  const KEY_OUT = "outgoingScript";

  // Заводские тексты: теперь в виде ПЛЕЙН-ТЕКСТА (без <br> и HTML)
  const defaultIncoming =
`МП: Здравствуйте! Компания ИНСИ. Меня зовут Рыкунов Андрей, я руководитель проекта.
МП: Подскажите, пожалуйста, как могу к вам обращаться?
К: Сергей
МП: Приятно, Сергей, слушаю вас.
К: (Озвучивает запрос)
МП: Отлично, для того чтобы посчитать для вас стоимость ангара и подготовить КП, мне нужно задать несколько вопросов, хорошо?
К: Да, давайте.

МП: Сергей, подскажите, пожалуйста, в каком городе планируете строительство?
К: Екатеринбург
МП: Уточните, пожалуйста, длину и ширину здания.
К: 20×25
МП: Какая высота по стене нужна?
К: 6 метров
МП: Сергей, подскажите, какое будет назначение у здания?
К: Склад лакокрасочной продукции

МП: Уточните, кран-балка нужна будет?
К: Да
МП: Принято. Какая грузоподъёмность кран-балки?
К: 5 тонн
МП: Ходить будет на всю длину?
К: На всю длину
МП: Один кран или несколько?
К: Один`;

  const defaultOutgoing =
`МП: Здравствуйте! Компания ИНСИ. Меня зовут Рыкунов Андрей, я руководитель проекта.
МП: Подскажите, пожалуйста, как могу к вам обращаться?
К: (Имя)
МП: Вы ранее интересовались быстровозводимыми зданиями — актуально?
К: (Да/нет)
МП: Чтобы корректно посчитать стоимость и подготовить КП, задам несколько вопросов — удобно?`;

  function safeStorageGet(key) {
    try { return localStorage.getItem(key); } catch (_) { return null; }
  }
  function safeStorageSet(key, val) {
    try { localStorage.setItem(key, val); return true; } catch (_) { return false; }
  }

  function stripClientPrefix(line) {
    // Убираем только маркер клиента в начале строки: "К:", "К -", "К —" и т.п.
    return String(line).replace(/^\s*К\s*([:\-—])\s*/i, "");
  }

  function isMpLine(line) {
    return /^\s*МП\s*([:\-—])\s*/i.test(line);
  }

  function stripMpPrefix(line) {
    return String(line).replace(/^\s*МП\s*([:\-—])\s*/i, "");
  }

  function escapeRegExp(s) {
    return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function renderScriptLines(container, rawText, query) {
    container.innerHTML = "";

    const q = String(query || "").trim();
    const re = q ? new RegExp(escapeRegExp(q), "gi") : null;

    const lines = String(rawText ?? "").replace(/\r\n/g, "\n").split("\n");

    for (const lineRaw of lines) {
      const line = String(lineRaw);

      // Пустая строка = gap
      if (line.trim() === "") {
        const gap = document.createElement("div");
        gap.className = "line gap";
        container.appendChild(gap);
        continue;
      }

      const row = document.createElement("div");
      row.className = "line";

      let text = line;
      let mode = "cl"; // по умолчанию — клиент/прочее

      if (isMpLine(line)) {
        mode = "mp";
        text = stripMpPrefix(line);
      } else {
        text = stripClientPrefix(line);
      }

      const span = document.createElement("span");
      if (mode === "mp") span.className = "mp-pill";
      else span.className = "cl-text";

      // Подсветка совпадений внутри строки
      if (!re) {
        span.textContent = text;
      } else {
        const parts = [];
        let last = 0;
        let m;
        re.lastIndex = 0;

        while ((m = re.exec(text)) !== null) {
          const before = text.slice(last, m.index);
          if (before) parts.push({t: before, h: false});
          parts.push({t: m[0], h: true});
          last = m.index + m[0].length;
          if (m[0].length === 0) break;
        }
        const after = text.slice(last);
        if (after) parts.push({t: after, h: false});

        for (const p of parts) {
          if (!p.h) span.appendChild(document.createTextNode(p.t));
          else {
            const mark = document.createElement("span");
            mark.className = "highlight";
            mark.textContent = p.t;
            span.appendChild(mark);
          }
        }
      }

      row.appendChild(span);
      container.appendChild(row);
    }
  }

  function getRaw(type) {
    const key = type === "incoming" ? KEY_IN : KEY_OUT;
    const def = type === "incoming" ? defaultIncoming : defaultOutgoing;
    return safeStorageGet(key) || def;
  }

  function setRaw(type, val) {
    const key = type === "incoming" ? KEY_IN : KEY_OUT;
    return safeStorageSet(key, String(val ?? ""));
  }

  function render(type) {
    const raw = getRaw(type);
    const query = document.getElementById(type + "-search")?.value?.trim() || "";
    const box = document.getElementById(type + "-text");
    renderScriptLines(box, raw, query);
  }

  function loadIntoEditor() {
    document.getElementById("incoming-edit").value = getRaw("incoming");
    document.getElementById("outgoing-edit").value = getRaw("outgoing");
  }

  function switchTab(name) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

    document.getElementById(name).classList.add("active");
    document.querySelector(`.tab-btn[data-tab="${name}"]`)?.classList.add("active");

    if (name === "incoming") render("incoming");
    if (name === "outgoing") render("outgoing");
    if (name === "edit") loadIntoEditor();
  }

  async function copyBoxText(boxId) {
    const el = document.getElementById(boxId);
    const text = el ? el.innerText : "";

    try {
      if (window.isSecureContext && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      alert("Скопировано!");
    } catch (e) {
      alert("Не удалось скопировать (проверь HTTPS/права браузера).");
    }
  }

  function downloadAll() {
    const i = getRaw("incoming");
    const o = getRaw("outgoing");
    const blob = new Blob([`INCOMING:\n${i}\n\nOUTGOING:\n${o}\n`], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "scripts-backup.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function resetToDefault() {
    if (!confirm("Сбросить к заводским?")) return;
    try { localStorage.removeItem(KEY_IN); localStorage.removeItem(KEY_OUT); } catch (_) {}
    render("incoming");
    render("outgoing");
    loadIntoEditor();
  }

  document.addEventListener("DOMContentLoaded", () => {
    render("incoming");
    render("outgoing");

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });

    document.getElementById("incoming-search").addEventListener("input", () => render("incoming"));
    document.getElementById("outgoing-search").addEventListener("input", () => render("outgoing"));

    document.querySelectorAll("[data-save]").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.save;
        const val = document.getElementById(type + "-edit").value;
        if (setRaw(type, val)) {
          render(type);
          alert("Сохранено!");
        } else {
          alert("Не удалось сохранить (localStorage недоступен).");
        }
      });
    });

    document.querySelectorAll("[data-copy]").forEach(btn => {
      btn.addEventListener("click", () => copyBoxText(btn.dataset.copy));
    });

    document.getElementById("download-btn").addEventListener("click", downloadAll);
    document.getElementById("reset-btn").addEventListener("click", resetToDefault);

    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.code === "KeyI") { e.preventDefault(); switchTab("incoming"); }
      if (e.ctrlKey && e.code === "KeyO") { e.preventDefault(); switchTab("outgoing"); }
    });
  });
})();
</script>
</body>
</html>
